version: "0.29.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path:
        - Items
  requester:
    type: HttpRequester
    url_base: "https://api.awtomic.com/"
    http_method: "GET"
    authenticator:
      type: ApiKeyAuthenticator
      api_token: "{{ config['api_key'] }}"
      inject_into:
        type: RequestOption
        field_name: x-api-key
        inject_into: header
  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: DefaultPaginator
      page_token_option:
        type: RequestOption
        inject_into: request_parameter
        field_name: lastEvaluatedKey
      page_size_option:
        type: RequestOption
        field_name: limit
        inject_into: request_parameter
      pagination_strategy:
        class_name: "source_awtomic.components.LastEvaluatedKeyPaginationStrategy"
        type: "CustomPaginationStrategy"
        page_size: 100
    requester:
      $ref: "#/definitions/requester"
  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"
  subscriptions_stream:
    $ref: "#/definitions/base_stream"
    name: "Subscriptions"
    primary_key: "SubscriptionId"
    $parameters:
      path: "/subscriptions"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/schema#
        properties:
          BillingIntervalBillingCount:
            type: string
          CreatedAt:
            type: string
          CurrencyCode:
            type: string
          CustomAttributes:
            items:
              properties:
                __typename:
                  type: string
                key:
                  type: string
                value:
                  type: string
              type: object
            type: array
          Customer:
            properties:
              acceptsMarketing:
                type: boolean
              displayName:
                type: string
              email:
                type: string
              id:
                type: string
              imageSrc:
                type: string
              locale:
                type: string
              phone:
                type: string
              productSubscriberStatus:
                type: string
              validEmailAddress:
                type: boolean
              verifiedEmail:
                type: boolean
            type: object
          CustomerId:
            type: string
          CustomerPaymentMethod:
            properties:
              id:
                type: string
              instrument:
                properties:
                  __typename:
                    type: string
                  billingAddress:
                    properties:
                      address1:
                        type: string
                      city:
                        type: string
                      country:
                        type: string
                      countryCode:
                        type: string
                      province:
                        type: string
                      provinceCode:
                        type: string
                      zip:
                        type: string
                    type: object
                  brand:
                    type: string
                  expiryMonth:
                    type: string
                  expiryYear:
                    type: string
                  lastDigits:
                    type: string
                type: object
              revokedAt:
                type: string
            type: object
          DeliveryBatchingAnchor:
            type: array
          DeliveryIntervalDeliveryCount:
            type: string
          DeliveryMethod:
            properties:
              address:
                properties:
                  address1:
                    type: string
                  address2:
                    type: string
                  city:
                    type: string
                  country:
                    type: string
                  countryCode:
                    type: string
                  name:
                    type: string
                  phone:
                    type: string
                  province:
                    type: string
                  provinceCode:
                    type: string
                  zip:
                    type: string
                type: object
              shippingOptions:
                properties:
                  code:
                    type: string
                  description:
                    type: string
                  presentmentTitle:
                    type: string
                type: object
            type: object
          DeliveryPriceAmount:
            type: number
          DeliveryPriceCurrencyCode:
            type: string
          Discounts:
            type: array
          HasPrepaidLines:
            type: boolean
          IsUpdating:
            type: boolean
          ItemTypeSubscriptionStatusNextBillingDate:
            type: string
          LineCount:
            type: number
          MarketOverrideCountryCode:
            type: string
          NextBillingDate:
            type: string
          NextBillingUpcomingDate:
            type: string
          NextBillingUpcomingYearMonth:
            type: string
          NextBillingYearMonth:
            type: string
          OriginOrderId:
            type: string
          PK:
            type: string
          SK:
            type: string
          ShopDomain:
            type: string
          SubscriptionContractNextBillingDate:
            type: string
          SubscriptionId:
            type: string
          SubscriptionStatus:
            type: string
          UpdatedAt:
            type: string
        type: object

  subscriptions_contract_stream:
    $ref: "#/definitions/base_stream"
    name: "subscription_contract"
    primary_key: "SubscriptionId"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: customers/{{ stream_slice.customer_id[22:] }}/subscriptions"
        request_parameters: {'expandLines':'true'}
      partition_router:
        type: SubstreamPartitionRouter
        parent_stream_configs:
          - stream: "#/definitions/subscriptions_stream"
            parent_key:  "CustomerId"
            partition_field: "customer_id"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/schema#
        properties:
          BillingIntervalBillingCount:
            type: string
          CreatedAt:
            type: string
          CurrencyCode:
            type: string
          CustomAttributes:
            items:
              properties:
                __typename:
                  type: string
                key:
                  type: string
                value:
                  type: string
              type: object
            type: array
          CustomerId:
            type: string
          CustomerPaymentMethod:
            properties:
              id:
                type: string
              instrument:
                properties:
                  __typename:
                    type: string
                  billingAddress:
                    properties:
                      address1:
                        type: string
                      city:
                        type: string
                      country:
                        type: string
                      countryCode:
                        type: string
                      province:
                        type: string
                      provinceCode:
                        type: string
                      zip:
                        type: string
                    type: object
                  brand:
                    type: string
                  expiryMonth:
                    type: string
                  expiryYear:
                    type: string
                  lastDigits:
                    type: string
                type: object
              revokedAt:
                type: string
            type: object
          DeliveryBatchingAnchor:
            type: array
          DeliveryIntervalDeliveryCount:
            type: string
          DeliveryMethod:
            properties:
              address:
                properties:
                  address1:
                    type: string
                  address2:
                    type: string
                  city:
                    type: string
                  country:
                    type: string
                  countryCode:
                    type: string
                  name:
                    type: string
                  phone:
                    type: string
                  province:
                    type: string
                  provinceCode:
                    type: string
                  zip:
                    type: string
                type: object
              shippingOptions:
                properties:
                  code:
                    type: string
                  description:
                    type: string
                  presentmentTitle:
                    type: string
                type: object
            type: object
          DeliveryPriceAmount:
            type: number
          DeliveryPriceCurrencyCode:
            type: string
          DiscountCodes:
            type: array
          Discounts:
            type: array
          FormattedDeliveryPrice:
            type: string
          FormattedFrequency:
            type: string
          FormattedShippingDiscount:
            type: string
          FormattedSubscriptionTotal:
            type: string
          HasPrepaidLines:
            type: boolean
          IsUpdating:
            type: boolean
          ItemTypeSubscriptionStatusNextBillingDate:
            type: string
          LineCount:
            type: number
          Lines:
            items:
              properties:
                CurrentPriceAmount:
                  type: string
                CurrentPriceCurrencyCode:
                  type: string
                CustomAttributes:
                  items:
                    properties:
                      __typename:
                        type: string
                      key:
                        type: string
                      value:
                        type:
                          - 'null'
                          - string
                    type: object
                  type: array
                CustomerId:
                  type: string
                DiscountAllocations:
                  type: array
                FormattedItemPrice:
                  type: string
                FormattedLineTotal:
                  type: string
                FormattedPricingPolicyBasePrice:
                  type: string
                FormattedPricingPolicyBasePriceMultipliedQuantiy:
                  type: string
                ItemTypeSubscriptionStatusNextBillingDate:
                  type: string
                LineDiscountedPriceAmount:
                  type: string
                LineDiscountedPriceCurrencyCode:
                  type: string
                NextBillingDate:
                  type: string
                NextBillingYearMonth:
                  type: string
                PK:
                  type: string
                PricingPolicyBasePriceAmount:
                  type: string
                PricingPolicyBasePriceCurrencyCode:
                  type: string
                PricingPolicyCycleDiscounts:
                  items:
                    properties:
                      adjustmentType:
                        type: string
                      adjustmentValue:
                        properties:
                          percentage:
                            type: number
                        type: object
                      afterCycle:
                        type: number
                      computedPrice:
                        properties:
                          amount:
                            type: string
                          currencyCode:
                            type: string
                        type: object
                    type: object
                  type: array
                ProductId:
                  type: string
                Quantity:
                  type: number
                RequiresShipping:
                  type: boolean
                SK:
                  type: string
                SKU:
                  type: string
                SellingPlanId:
                  type: string
                SellingPlanName:
                  type: string
                ShopDomain:
                  type: string
                SubscriptionContractId:
                  type: string
                SubscriptionContractLineId:
                  type: string
                SubscriptionId:
                  type: string
                SuccessfulBillingAttempts:
                  items:
                    type: string
                  type: array
                Title:
                  type: string
                VariantId:
                  type: string
                VariantImageSrc:
                  type: string
                VariantTitle:
                  type: string
              type: object
            type: array
          MarketOverrideCountryCode:
            type: string
          NextBillingDate:
            type: string
          NextBillingUpcomingDate:
            type: string
          NextBillingUpcomingYearMonth:
            type: string
          NextBillingYearMonth:
            type: string
          OriginOrderId:
            type: string
          PK:
            type: string
          SK:
            type: string
          ShippingDiscountAmount:
            type: number
          ShopDomain:
            type: string
          ShopifyUpdatedAt:
            type: string
          SubscriptionContractNextBillingDate:
            type: string
          SubscriptionId:
            type: string
          SubscriptionStatus:
            type: string
          SubscriptionTotal:
            type: number
        type: object

streams:
  - "#/definitions/subscriptions_stream"
  - "#/definitions/subscriptions_contract_stream"

check:
  type: CheckStream
  stream_names:
    - "Subscriptions"

spec:
  type: Spec
  documentation_url: https://docs.airbyte.com/integrations/sources/awtomic
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    type: object
    required:
      - api_key
    properties:
      api_key:
        type: string
        title: API Key
        airbyte_secret: true
        description: >-
          A Awtomic token. See the <a
          href="https://docs.awtomic.com/reference/intro/getting-started">docs</a>
          for instructions on how to generate it.
        order: 0
    additionalProperties: true